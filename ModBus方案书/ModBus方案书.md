# ModBus项目方案书

##  一 . 项目背景

ModBus是工业自动化的常用协议，学习该协议是从事自动化相关行业的必经之路。而自主实现ModBus协议可以帮助学习者完善所学知识，更深层次的全面理解并掌握该协议，发现并弥补学习的漏洞。

## 二 . 目标
- 实现ModBus从站
	· 能够正常连接
	· 能够判断连接断开
	· 能够正确解析请求帧
	· 对于正确请求帧给出正确应答帧
	· 对于错误请求帧给出错误应答帧或按规格给出相应的处理
	
- 实现ModBus主站
	· 能够正常连接
	· 能够判断连接断开
	
	· 能够按要求生成请求帧
	· 能够正确解析应答帧，并做相应处理
	· 能够进行超时处理
	· 拥有美观易操作的人机界面

## 三. 核心需求分析

- RTU主站

  1. 拥有美观易操作的人机界面

     - 可以方便的选择当前可用串口号、本机地址、波特率、数据位、停止位和奇偶校验位

     - 可以方便的进行串口的打开和关闭，并进行打开成功提示和关闭询问和提示

     - 可以方便的查看和搜索数据文件中的线圈和寄存器的地址和数据信息，并且在数据改变时要及时更新

     - 可以清晰的显示接收到的响应报文信息和处理信息，展示出何时何串口收到何种消息，并展示出处理信息

     - 可以保持显示界面的易读性，保证可以看到最新的消息，并且可以自主清理消息窗口

     - 可以方便的查看历史消息

  2. 进行串口打开

     - 能够获取用户选择的串口号、本机地址、波特率、数据位、停止位和奇偶校验位
     - 能够按照获取到的用户选择参数配置串口
     - 串口打开后，关闭串口参数设置的按钮
     - 能够在串口成功打开或打开失败时给与提示信息

  2. 主动串口关闭处理

     - 能够判断用户是否是主动关闭串口
  - 串口关闭，开启串口参数设置的按钮
     - 能够对关闭以后的状态进行设置处理，使其整体回到串口打开前的状态，并且不影响下一次通信

  2. 生成请求报文

     - 能够将获得的用户数据转化为请求报文数据
     - 能根据不同的功能码类型生成请求报文，若为写入请求报文，能够正确获得用户输入，并进行处理转化为报文数据
     
  5. 发送请求报文

     - 能够判断发送时的RTU串口状态，若串口状态为关闭状态则不能发送，并给出提示，且能够将状态设置为RTU串口开启前的状态，使其不影响下一次通信
     - 能够进行超时响应，当从站在规定时间内无响应时，应启动超时响应，进行若干次的重发操作，并给出提示。当超出重发上限后应给出提示，并且能够将状态设置为初始转台，使其不影响下一次通信

  6. 解析响应报文

     - 能够正确接收响应报文，并对其进行相应处理
     - 能够判断当前主站是否需要响应
     - 能够判断请求报文是否合法
     - 能够正确处理错误报文并给出提示
     - 能够正确处理异常报文，并给出提示和发送异常响应报文
     - 能够正确处理正常响应报文，并给出成功提示

  2. 数据和消息保存

     - 能够及时的更新本地数据文件，防止数据丢失

     - 能够将消息窗口的消息记录保存到指定文件，防止信息丢失，方便后续查阅

       

- RTU从站

  1. 拥有美观易操作的人机界面

     - 可以方便的选择当前可用串口号、本机地址、波特率、数据位、停止位和奇偶校验位
     - 可以方便的进行串口的打开和关闭，并进行打开成功提示和关闭询问和提示
     - 可以方便的查看和搜索数据文件中的线圈和寄存器的地址和数据信息，并且在数据改变时要及时更新
     - 可以清晰的显示接收到的响应报文信息和处理信息，展示出何时何串口收到何种消息，并展示出处理信息
     - 可以保持显示界面的易读性，保证可以看到最新的消息，并且可以自主清理消息窗口
     - 可以方便的查看历史消息
     
  2. 进行串口打开
  
     - 能够获取用户选择的串口号、本机地址、波特率、数据位、停止位和奇偶校验位
     - 能够按照获取到的用户选择参数配置串口
     - 能够在串口成功打开或打开失败时给与提示信息
     
  3. 主动串口关闭处理
  
     - 能够判断用户是否是主动关闭串口
     - 能够对关闭以后的状态进行设置处理，使其整体回到串口打开前的状态，并且不影响下一次通信
     
  4. 被动串口关闭处理
     - 能够检测串口被动异常关闭，例如串口拔出
     - 当检测到被动串口关闭异常时，可以立即给出警告提示，并且能够对关闭以后的状态进行设置处理，使其整体回到串口打开前的状态，并且不影响下一次通信
     
  5. 正确解析请求报文
     
     - 能够正确接收请求报文，并对其进行相应处理
     - 能够判断当前从站是否需要响应
     - 能够判断请求报文是否合法
     - 能够正确处理错误报文并给出提示
     - 能够正确处理异常报文，并给出提示和发送异常响应报文
     - 能够正确处理正常请求报文，并给出成功提示
     
  5. 生成响应报文
     
     - 能根据不同的功能码类型生成响应报文，如果为查询报文，获得本地数据并转化为响应报文数据
     - 请求报文异常，需要进行异常响应时，生成异常响应报文
     
  7. 发送响应报文
  
     - 能够判断发送时的RTU串口状态，若串口状态为关闭状态则不能发送，并给出提示，且能够将状态设置为RTU串口开启前的状态，使其不影响下一次通信
  
  8. 数据和消息保存
     - 能够及时的更新本地数据文件，防止数据丢失
     
     - 能够将消息窗口的消息记录保存到指定文件，防止信息丢失，方便后续查阅
     
       
  
- TCP主站

  1. 拥有美观易操作的人机界面

     - 可以方便的设置IP地址和端口号，能够给出默认地址项
     - 可以方便的选择从机地址、功能码、起始地址和数量，并可以给出相应的范围提示保证用户输入合法值
     - 可以方便的进行TCP的连接与断开，并进行连接成功提示和断开询问和提示
     - 可以方便的进行请求报文的发送
     - 当用户选择写入功能码时，可以使用美观的对话框获取用户输入，并适当给与提示
     - 可以清晰的显示发送的请求信息和收到的响应信息，并显示出时间信息和地址信息
     - 可以保持显示界面的易读性，保证可以看到最新的消息，并且可以自主清理消息窗口
     - 可以方便的查看历史消息
  2. TCP连接
  
     - 能够获得用户输入的目标IP地址、端口号、从机地址、功能码、起始地址和数量
  
     - 能够根据获取的用户参数连接目标IP
  
     - 能够在连接成功或失败时给出相应提示信息
  3. TCP断开

     - 能够判断用户主动断开TCP的行为，并且给与二次确认并进行提示
     - 能够自动检测TCP的被动异常断开状态，并立即给出警告提示
     - 能够对断开以后的状态进行设置处理，使其整体回到TCP连接前的状态，并且不影响下一次通信
  4. 生成请求报文
  
     - 能够将获得的用户数据转化为请求报文数据
     - 能根据不同的功能码类型生成请求报文，若为写入请求报文，能够正确获得用户输入，并进行处理转化为报文数据
  5. 发送请求报文
  
     - 能够判断发送时的TCP连接状态，若TCP为断开状态则不能发送，并给出提示，且能够将状态设置为TCP连接前的状态，使其不影响下一次通信
     - 能够进行超时响应，当从站在规定时间内无响应时，应启动超时响应，进行若干次的重发操作，并给出提示。当超出重发上限后应给出提示，并且能够将状态设置为TCP连接前的状态，使其不影响下一次通信
  6. 正确解析响应报文

     - 能够正确接收响应报文，并对其进行相应处理
     - 能够判断当前主站是否需要响应
     - 能够判断请求报文是否合法
     - 能够正确处理错误报文并给出提示
     - 能够正确处理异常报文，并给出提示和发送异常响应报文
     - 能够正确处理正常响应报文，并给出成功提示
  7. 消息保存
  
     - 能够将消息窗口的消息记录保存到指定文件，防止信息丢失，方便后续查阅

- TCP从站

  1. 拥有美观易操作的人机界面
  
     - 可以方便的设置IP地址和端口号，当ip地址和端口号为空时，使用默认值。
     - 利用刷新按钮，获取本机在局域网下的ip，并放置到ip地址框中
     - 可以方便的进行ip和端口的监听，显示出具体的连接信息，并进行成功提示和关闭提示
     - 可以方便的查看和搜索数据文件中的线圈和寄存器的地址和数据信息，并且在数据改变时要及时更新
     - 可以清晰的显示接收到的响应报文信息和处理信息，显示具体的报文，以及报文的来源
     - 可以保持显示界面的易读性，保证可以看到最新的消息，并且可以自主清理消息窗口
     - 可以方便的查看历史消息
  2. 监听指定ip和端口
  
     - 能够获取界面的ip地址，端口号，从机地址，并判断其合法性，不合法则使用默认值
     - 开启监听，关闭参数设置框
     - 关闭监听，开启参数设置框，判断时候存在连接，若有连接，则断开所有连接
     - 能够在监听成功或失败时给与提示信息
  3. 连接被动关闭
  
     - 能够判断用户是否是主动关闭连接，并给出提示信息
     - 重置当前状态为端口监听后的状态
  4. 连接主动关闭
     - 主动关闭现有连接，并给出提示信息
     - 重置当前状态为端口监听后的状态
  5. 正确解析请求报文
  
     - 能够正确接收请求报文，并对其进行相应处理
     - 能够判断当前从站是否需要响应
     - 能够判断请求报文是否合法
     - 能够正确处理错误报文并给出提示
     - 能够正确处理异常报文，并给出提示和发送异常响应报文
     - 能够正确处理正常请求报文，并给出成功提示
  6. 生成响应报文
     - 能根据不同的功能码类型生成响应报文，如果为查询报文，获得本地数据并转化为响应报文数据
     - 请求报文异常，需要进行异常响应时，生成异常响应报文
  7. 发送响应报文
  
     - 能够判断发送时的TCP连接状态，若为关闭状态则不能发送，并给出提示。
  8. 数据和消息保存
     - 能够及时的更新本地数据文件，防止数据丢失
     - 能够将消息窗口的消息记录保存到指定文件，防止信息丢失，方便后续查阅

## 四. 方案流程图

### RTU主站

#### 功能模块

- 内容：

  - 串口
    - 串口开关
    - 串口断开检测
  - 报文处理
    - 请求报文生成
    - 响应报文解析
  - 消息日志
    - 消息日志记录
    - 消息日志查看
  - 数据
    - 数据显示
    - 数据搜索

![](pic/1.png)

#### 1. 串口

串口检测:

![](pic/18.png)

##### 1.1 串口开关

串口开启：

![](pic/4.png)

串口关闭：

![](pic/2.png)

##### 1.2 串口断开

串口断开：

![](pic/3.png)

串口通信：

![](pic/16.png)

#### 2.报文处理

主要流程：

![](pic/11.png)

##### 请求报文生成

0x01 和 0x03报文生成

![](pic/12.png)

0x0f 和 0x10

![](pic/13.png)

##### 响应报文解析

异常响应报文解析

![](pic/20.png)

正常报文解析

![](pic/19.png)

#### 3.消息日志

##### 3.1消息日志写入

###### 定时写入：

![](pic/10.png)

###### 关闭程序写入：

![](pic/9.png)

##### 3.2消息日志查看

![](pic/8.png)

#### 4.数据

##### 4.1数据显示

![](pic/7.png)

##### 4.2数据搜索

![](pic/6.png)

### RTU从站

#### 1. 功能模块

- 内容：

  - 串口打开和关闭模块
  - 串口断开检测模块
  - ModBus报文处理模块
  - 清除消息窗口模块
  - 历史记录模块
  - 数据搜索模块

- 框架图：

  ![功能框架](./pic/功能框架.png)

  

#### 1. 串口打开和关闭模块

#### 1.1 串口打开模块

- 内容：

  - 获取界面参数

  - 设置本机地址和串口号
  - 打开串口
  - 如果打开成功，则依次设置波特率、数据位、停止位、校验位，输出成功提示信息
  - 如果失败输出失败提示

- 流程图：

  ![串口连接函数](./pic/串口打开函数.png)



#### 1.2 串口关闭模块

- 内容：

  - 调整串口状态为关闭
  - 清空缓存区
  - 关闭、清除串口
  - 提示关闭信息
  
- 流程图：

  ![串口关闭函数](./pic/串口关闭函数.png)



#### 1.3. 串口断开检测模块

- 内容：

  - 获取串口断开错误
  - 提示断开信息
  - 执行串口关闭模块

- 流程图：

  ![串口断开检测函数](./pic/串口断开检测函数.png)



#### 2. ModBus报文处理模块

![ModBus报文处理](./pic/ModBus报文处理.png)

#### 2.1 解析请求报文模块

- 内容：

  - 分析报文合法性，分析出公共数据项
  - 显示收到的报文
  - 解析报文：判断CRC校验码、从站地址、功能码
  - 错误显示错误信息
  - 正确则按功能码进行深层解析

- 流程图：

  ![报文解析函数](./pic/报文解析函数.png)



#### 2.1.1 功能码0X01和0X03请求报文解析

- 内容：

  - 判断请求帧长度合法性
  - 判断请求报文的起始地址合法性、数量项合法性、该起始地址能否读取请求数量的线圈
  - 异常发送异常响应报文
  - 正常发送正常响应报文

- 流程图：

  ![功能码0X01和0X03请求报文解析函数](./pic/功能码0X01和0X03请求报文解析函数.png)



#### 2.1.2 功能码0X0F请求报文解析

- 内容：

  - 判断请求报文的起始地址合法性、数量项合法性、该起始地址能否写入请求数量的线圈、字节数字段正确性、字节字段长度是否匹配
  - 异常发送异常响应报文
  - 正常则将线圈写入线圈数据表，并更新ini文件，并发送正常响应报文

- 流程图：

  ![功能码0X0F请求报文解析函数](./pic/功能码0X0F请求报文解析函数.png)



#### 2.1.3 功能码0X10请求报文解析

- 内容：

  - 判断请求报文的起始地址合法性、数量项合法性、该起始地址能否写入请求数量的寄存器、字节数字段正确性、字节字段长度是否匹配
  - 异常发送异常响应报文
  - 正常则将线圈写入寄存器数据表，并更新ini文件，并发送正常响应报文

- 流程图：

  ![功能码0X10请求报文解析函数](./pic/功能码0X10请求报文解析函数.png)



#### 2.2 生成响应报文模块

#### 2.2.1 异常响应报文发送和显示

- 内容：

  - 通过异常响应报文数组构建得到异常响应报文
  - 发送响应报文
  - 显示异常类型
  - 显示异常响应报文

- 流程图：

  ![异常响应报文发送和显示函数](./pic/异常响应报文发送和显示函数.png)



#### 2.2.2 异常响应报文数组构建

- 内容：根据本机地址、功能码和异常码构建异常响应报文

- 流程图：

  ![异常响应报文数组构建函数](./pic/异常响应报文数组构建函数.png)



#### 2.2.3 正常响应报文发送和显示

- 内容：

  - 通过正常响应报文数组构建得到正常响应报文
  - 发送响应报文
  - 显示响应报文

- 流程图：

  ![正常响应报文发送和显示函数](./pic/正常响应报文发送和显示函数.png)





#### 2.2.4 正常响应报文数组构建

- 内容：根据功能码进行创建报文

- 流程图：

  ![正常响应报文数组构建](./pic/正常响应报文数组构建.png)



#### 4.  清除消息窗口模块

- 内容：

  - 对话框二次确认是否清除
  - 如果确认清除，清除消息窗口，并将数据保存到指定文件

- 流程图：

  ![清除消息窗口函数](./pic/清除消息窗口函数.png)

#### 4.  历史记录模块

#### 4.1 查看历史记录模块

- 内容：

  - 判断有无文件路径
  - 如果有文件路径则进入显示历史消息函数进行显示
  - 如果没有文件路径先弹出对话框进行选择路径
  - 如果选择路径为空则提示打开失败
  - 如果路径合法则提示成功，并进入显示历史消息函数进行显示

- 流程图：

  ![查看历史消息槽函数](./pic/查看历史消息槽函数.png)



#### 4.2.  历史记录写入文件模块

- 内容：

  - 判断有无文件路径
  - 如果有路径则将历史记录写入文件
  - 如果没有路径，则先使用文件选择对话框选择文件路径
  - 若选择的路径为空，提示打开失败
  - 若选择的路径合法，则路径设置成功，并将消息框的信息写入文件

- 流程图：

  ![历史写入文件函数](./pic/历史写入文件函数.png)



#### 5. 搜索线圈和寄存器模块

- 内容：

  - 获取用户线圈数据表搜索和寄存器数据表搜索的位置
  - 将数据表显示到该位置

- 流程图：

  ![搜索槽函数](./pic/搜索槽函数.png)



### TCP主站

#### 1.功能模块框架

- 内容：

  - TCP的连接和断开模块
  - ModBus报文处理模块
  - 清除消息窗口模块
  - 历史记录模块

- 框架图：

  ![框架](./Tpic/框架.png)



#### 2 .  TCP连接和断开模块

![连接按钮函数](./Tpic/连接按钮函数.png)



#### 3. ModBus报文处理模块

![ModBus报文处理](./Tpic/ModBus报文处理.png)

##### 3.1 生成和发送请求报文模块

- 内容：

  - 判断用户输入的功能码，根据功能码进入对应的生成函数
  - 进行响应报文超时判断和超时重传

- 流程图：

  ![发送按钮函数](./Tpic/发送按钮函数.png)



##### 3.1.1 处理0X01和0X03请求报文

![0X01和0X03请求报文生成和发送函数](./Tpic/0X01和0X03请求报文生成和发送函数.png)



##### 3.1.2 处理0X0F和0X10请求报文

![0X0F请求报文生成和发送函数](./Tpic/0X10请求报文生成和发送函数.png)



##### 3.2 解析响应报文

![解析响应报文](./Tpic/解析响应报文.png)



##### 3.2.1 报文合法性判断

![报文合法性判断](./Tpic/报文合法性判断.png)



##### 3.2.2 0X01和0X03功能码报文处理

![0X01和0X03功能码报文处理](./Tpic/0X01和0X03功能码报文处理.png)



##### 3.2.3 0X0F和0X10功能码报文处理

![0X0F和0X10功能码报文处理](./Tpic/0X0F和0X10功能码报文处理.png)



#### 4.  清除消息窗口模块

- 内容：

  - 对话框二次确认是否清除
  - 如果确认清除，清除消息窗口，并将数据保存到指定文件

- 流程图：

  ![清除消息窗口函数](./pic/清除消息窗口函数.png)

#### 5.  历史记录模块

##### 5.1 查看历史记录模块

- 内容：

  - 判断有无文件路径
  - 如果有文件路径则进入显示历史消息函数进行显示
  - 如果没有文件路径先弹出对话框进行选择路径
  - 如果选择路径为空则提示打开失败
  - 如果路径合法则提示成功，并进入显示历史消息函数进行显示

- 流程图：

  ![查看历史消息槽函数](./pic/查看历史消息槽函数.png)



##### 5.2.  历史记录写入文件模块

- 内容：

  - 判断有无文件路径
  - 如果有路径则将历史记录写入文件
  - 如果没有路径，则先使用文件选择对话框选择文件路径
  - 若选择的路径为空，提示打开失败
  - 若选择的路径合法，则路径设置成功，并将消息框的信息写入文件

- 流程图：

  ![历史写入文件函数](./pic/历史写入文件函数.png)

### TCP从站

#### 功能模块

![](pic/21.png)

主要流程

![](pic/22.png)

#### 1.连接

![](pic/17.png)

#### 2.报文处理

##### 2.1请求报文解析

![](pic/23.png)

0x01 和 0x03 报文解析

![功能码0X01和0X03请求报文解析函数](./pic/功能码0X01和0X03请求报文解析函数.png)

0x0f 报文解析

![功能码0X0F请求报文解析函数](./pic/功能码0X0F请求报文解析函数.png)



0x10 报文解析

![功能码0X0F请求报文解析函数](./pic/功能码0X0F请求报文解析函数.png)

##### 2.2响应报文生成

正常报文生成

![](pic/24.png)

异常报文生成

![](pic/25.png)

#### 3.消息日志

##### 3.1消息日志写入

###### 定时写入：

![](pic/10.png)

###### 关闭程序写入：

![](pic/9.png)

##### 3.2消息日志查看

![](pic/8.png)

#### 4.数据

##### 4.1数据显示

![](pic/7.png)

##### 4.2数据搜索

![](pic/6.png)
